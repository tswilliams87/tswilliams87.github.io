<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Missed Connections
  </title>
  <link href="/styles.css" rel="stylesheet"/>
  <link href="/favicon.png" rel="icon" type="image/png"/>
  <style>
    body {
      padding-top: 60px; /* Adjust according to navbar height */
    }
  </style>
 </head>
 <body>
  <div class="navbar" id="navbar">
    <!-- Dynamic nav links will be injected here -->
  </div>
  <div class="profile-container">
   <div class="card" id="card">
    <div class="card-inner">
     <div class="card-face front">
      <img alt="Profile Image" id="profile-img" src=""/>
     </div>
     <div class="card-face back">
      <div class="profile-bio" id="profile-bio">
       <h1 id="profile-name"></h1>
       <p id="profile-fav"></p>
       <p id="profile-bio-text"></p>
      </div>
     </div>
    </div>
   </div>
   <div class="swipe-zone left" id="nope-zone"></div>
   <div class="flip-zone" id="flip-zone"></div>
   <div class="swipe-zone right" id="yes-zone"></div>
  </div>
 <script type="module">
import { fetchProfiles } from './api.js';
import { Storage, Auth } from 'aws-amplify';
import awsconfig from './aws-exports.js';
import { Amplify } from 'aws-amplify';
import { updateUserLocationToAPI } from './main.js';
Amplify.configure(awsconfig);

let profiles = [];
let currentIndex = 0;
const imageCache = {};

const card = document.getElementById('card');
const imgEl = document.getElementById('profile-img');
const nameEl = document.getElementById('profile-name');
const favEl = document.getElementById('profile-fav');
const bioEl = document.getElementById('profile-bio-text');

async function loadProfiles() {
  try {
    const response = await fetchProfiles();
    profiles = response || [];
    currentIndex = 0;
    showProfile();
  } catch (error) {
    console.error('Failed to load profiles:', error);
  }
}

async function getImageUrl(s3Key) {
  if (!imageCache[s3Key]) {
    try {
      imageCache[s3Key] = await Storage.get(s3Key, { level: 'public' });
    } catch (err) {
      console.error('Image load error:', s3Key, err);
      imageCache[s3Key] = 'https://via.placeholder.com/600x800';
    }
  }
  return imageCache[s3Key];
}

async function preloadNextImage() {
  const nextIndex = (currentIndex + 1) % profiles.length;
  const nextProfile = profiles[nextIndex];
  const nextKey = nextProfile.picture?.S || `profiles/${nextProfile.filename?.S || ''}`;
  if (nextKey) getImageUrl(nextKey); // Trigger cache
}

async function showProfile() {
  if (currentIndex >= profiles.length) {
    currentIndex = 0;
  }

  const profile = profiles[currentIndex];
  const name = profile.name?.S || 'Unknown';
  const fav = profile.favoriteThing?.S || '';
  const s3Key = profile.picture?.S || `profiles/${profile.filename?.S || ''}`;
  const bio = profile.bio?.S || 'No bio available';

  nameEl.textContent = name;
  favEl.textContent = fav;
  bioEl.textContent = bio;

  const url = await getImageUrl(s3Key);
  imgEl.src = url;
  preloadNextImage();
}

function swipe(direction) {
  card.classList.remove('flipped');
  card.classList.add(direction === 'yes' ? 'swipe-right' : 'swipe-left');
  setTimeout(() => {
    card.classList.remove('swipe-right', 'swipe-left');
    currentIndex++;
    showProfile();
  }, 500);
}

document.getElementById('yes-zone').addEventListener('click', () => swipe('yes'));
document.getElementById('nope-zone').addEventListener('click', () => swipe('nope'));
document.getElementById('flip-zone').addEventListener('click', () => {
  const card = document.getElementById('card');
  card.classList.toggle('flipped');
});

loadProfiles();
updateUserLocationToAPI();

(async () => {
  const navbar = document.getElementById('navbar');
  try {
    const user = await Auth.currentAuthenticatedUser();
    const email = user.attributes.email;

    navbar.innerHTML = `
    <span style="color: #00ff22; margin-left: 15px; margin-right: auto;">Signed in as: ${email}</span>
      <a href="edit-profile.html">Profile</a>
      <button class="nav-link" id="signout-btn">Sign Out</button>
    `;

    document.getElementById('signout-btn')?.addEventListener('click', async () => {
      try {
        await Auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Sign out failed:', error);
      }
    });
  } catch {
    navbar.innerHTML = `
      <a href="signin.html">Sign-In</a>
      <a href="confirm-profile.html">Confirm Email</a>
      <a href="create-profile.html">Create Profile</a>
    `;
  }
})();
</script>
 </body>
</html>
